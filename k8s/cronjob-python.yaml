apiVersion: batch/v1
kind: CronJob
metadata:
  name: fox-auditoria-sync
  namespace: fox-auditoria
  labels:
    app: fox-auditoria
    component: sync-job
spec:
  # Executar a cada 5 minutos
  schedule: "*/5 * * * *"
  
  # Configura√ß√µes do CronJob
  concurrencyPolicy: Forbid  # N√£o permitir execu√ß√µes simult√¢neas
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 300  # 5 minutos para iniciar
  
  jobTemplate:
    spec:
      # Configura√ß√µes do Job
      backoffLimit: 2  # M√°ximo 2 tentativas
      activeDeadlineSeconds: 240  # Timeout de 4 minutos
      
      template:
        metadata:
          labels:
            app: fox-auditoria
            component: sync-job
        spec:
          restartPolicy: Never
          
          containers:
          - name: fox-auditoria-sync
            image: python:3.11-slim
            imagePullPolicy: IfNotPresent
            
            # Comando para executar sincroniza√ß√£o
            command: ["/bin/bash"]
            args:
              - -c
              - |
                echo "üöÄ Iniciando sincroniza√ß√£o FOX Auditoria..."
                echo "‚è∞ $(date): Job iniciado"
                
                # Instalar depend√™ncias como root
                echo "üì¶ Instalando depend√™ncias..."
                pip install --quiet --no-cache-dir pymongo==4.6.0 pandas==2.1.4 plotly==5.17.0
                
                # Executar script de sincroniza√ß√£o
                echo "üîÑ Executando sincroniza√ß√£o..."
                python3 /app/sync_job.py
                
                echo "‚úÖ $(date): Job conclu√≠do"
            
            # Vari√°veis de ambiente
            env:
            - name: MONGODB_URI
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: mongodb-uri
            - name: PYTHONPATH
              value: "/app"
            - name: PYTHONUNBUFFERED
              value: "1"
            
            # Volumes
            volumeMounts:
            - name: sync-code
              mountPath: /app
              readOnly: true
            
            # Recursos
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          
          # Volumes
          volumes:
          - name: sync-code
            configMap:
              name: fox-auditoria-sync-code
              defaultMode: 0755
          
          # Configura√ß√µes do Pod
          # securityContext removido para permitir instala√ß√£o de pacotes
          
          # Toler√¢ncias para execu√ß√£o em qualquer node
          tolerations:
          - key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"

